<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نتائج مصفوفة القرار</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; }
        .container { max-width: 90%; margin: 40px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #007bff; color: white; }
        input[type="range"] { width: 100px; }
        input[type="number"] { width: 60px; text-align: center; }
        .result-score { font-weight: bold; font-size: 1.2em; }
        .winner { background-color: #d4edda !important; color: #155724; }
        a { display: inline-block; margin-top: 20px; text-decoration: none; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="topic-title"></h1>
        <h2>مصفوفة القرار</h2>
        <table id="matrix-table">
            <!-- سيتم بناؤها بواسطة JavaScript -->
        </table>
        <a href="index.html">ابدأ قرارًا جديدًا</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const data = JSON.parse(localStorage.getItem('decisionData'));
            if (!data) {
                document.body.innerHTML = '<h1>خطأ: لا توجد بيانات. يرجى البدء من جديد.</h1><a href="index.html">عودة</a>';
                return;
            }

            const { topic, alternatives, criteria } = data;
            document.getElementById('topic-title').textContent = `موضوع القرار: ${topic}`;

            const table = document.getElementById('matrix-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // إنشاء رأس الجدول (المعايير والأوزان)
            let headerRow = '<tr><th>البديل / المعيار</th>';
            criteria.forEach((crit, index) => {
                headerRow += `<th>${crit}<br><small>الوزن: <span id="weight-val-${index}">5</span></small><br><input type="range" id="weight-${index}" min="1" max="10" value="5" oninput="updateCalculations()"></th>`;
            });
            headerRow += '<th>النتيجة النهائية</th></tr>';
            thead.innerHTML = headerRow;

            // إنشاء صفوف الجدول (البدائل والتقييمات)
            alternatives.forEach((alt, altIndex) => {
                let bodyRow = `<tr><td><strong>${alt}</strong></td>`;
                criteria.forEach((_, critIndex) => {
                    bodyRow += `<td><input type="number" id="score-${altIndex}-${critIndex}" min="1" max="10" value="5" oninput="updateCalculations()"></td>`;
                });
                bodyRow += `<td class="result-score" id="result-${altIndex}">-</td></tr>`;
                tbody.innerHTML += bodyRow;
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            
            updateCalculations(); // الحساب لأول مرة عند تحميل الصفحة
        });

        function updateCalculations() {
            const data = JSON.parse(localStorage.getItem('decisionData'));
            const { alternatives, criteria } = data;

            // تحديث قيم الأوزان المعروضة
            const weights = criteria.map((_, index) => {
                const weightInput = document.getElementById(`weight-${index}`);
                document.getElementById(`weight-val-${index}`).textContent = weightInput.value;
                return parseInt(weightInput.value, 10);
            });
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);

            let maxScore = -1;
            let winnerIndex = -1;

            // حساب النتائج لكل بديل
            alternatives.forEach((_, altIndex) => {
                let totalScore = 0;
                criteria.forEach((_, critIndex) => {
                    const score = parseInt(document.getElementById(`score-${altIndex}-${critIndex}`).value, 10) || 0;
                    totalScore += score * weights[critIndex];
                });

                const finalScore = totalWeight > 0 ? (totalScore / totalWeight).toFixed(2) : 0;
                document.getElementById(`result-${altIndex}`).textContent = finalScore;
                
                if (parseFloat(finalScore) > maxScore) {
                    maxScore = parseFloat(finalScore);
                    winnerIndex = altIndex;
                }
            });

            // إزالة التمييز السابق وإضافة تمييز للفائز الجديد
            document.querySelectorAll('tbody tr').forEach(row => row.classList.remove('winner'));
            if(winnerIndex !== -1) {
                document.querySelector(`#result-${winnerIndex}`).parentElement.classList.add('winner');
            }
        }
    </script>
</body>
</html>
